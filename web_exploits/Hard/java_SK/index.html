<html>
<head>    
    <script src="/jquery-3.3.1.min.js"></script>
    <script>
        var bytes = [];

        // Load the "bytes" data file
        $.get("bytes", function(resp) {
            bytes = Array.from(resp.split(" "), x => Number(x));
            console.log("Bytes loaded:", bytes);
        }).fail(function() {
            console.error("Failed to load bytes file");
        });

        function arrayBufferToBase64(buffer) {
            let binary = '';
            let bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function assemble_png(u_in) {
            var LEN = 16;
            var key = "0000000000000000";
            var shifter;

            if (u_in.length === LEN) {
                key = u_in;
            }

            if (bytes.length === 0) {
                console.error("Bytes array is empty. Ensure 'bytes' file is loaded before submission.");
                return false;
            }

            var result = [];
            for (var i = 0; i < LEN; i++) {
                shifter = key.charCodeAt(i) - 48;
                for (var j = 0; j < (bytes.length / LEN); j++) {
                    result[(j * LEN) + i] = bytes[(((j + shifter) * LEN) % bytes.length) + i];
                }
            }

            while (result[result.length - 1] === 0) {
                result = result.slice(0, result.length - 1);
            }

            var base64Image = arrayBufferToBase64(result);
            document.getElementById("Area").src = "data:image/png;base64," + base64Image;
            console.log("Image updated successfully.");

            return false;
        }
    </script>
</head>
<body>
    <center>
        <form action="#" onsubmit="event.preventDefault(); assemble_png(document.getElementById('user_in').value)">
            <input type="text" id="user_in">
            <input type="submit" value="Submit">
        </form>
        <img id="Area" src=""/>
    </center>
</body>
</html>
